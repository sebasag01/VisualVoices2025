<app-header></app-header>

<div class="container">

  <!-- PANTALLA 1: Formulario para ingresar nombres de jugadores + Botón Empezar -->
  <div *ngIf="uiState === 'nombres'" class="start-container">

    <div class="players-form">
      <h3>Jugadores</h3>

      <label>
        Jugador 1:
        <input type="text" [(ngModel)]="player1Name" placeholder="Nombre jugador 1"/>
      </label>

      <label>
        Jugador 2:
        <input type="text" [(ngModel)]="player2Name" placeholder="Nombre jugador 2"/>
      </label>
    </div>

    <button (click)="onStartButton()" class="start-button">
      Empezar
    </button>

  </div>

  <!-- PANTALLA 2: Pantalla en blanco con mensaje “Turno de X...” -->
  <div *ngIf="uiState === 'turnAnnounce'" class="turn-announce-container">
    <h1>Turno de {{ currentTurnName  }}...</h1>
  </div>

  <!-- PANTALLA 3: Modo Versus normal -->
  <div *ngIf="uiState === 'playing'" class="content">
    <div class="layout">
      <!-- Contenedor izquierdo: Avatar O Video -->
      <div class="image-container" id="avatar-element">
        <!-- El avatar (Canvas 3D) solo aparece si NO estamos mostrando el video grabado -->
        <app-canvas 
          *ngIf="!showRecordedVideo"
          [animationUrls]="animaciones"
        ></app-canvas>

        <!-- Cuando showRecordedVideo es true, se muestra el video grabado en su lugar -->
        <video 
          *ngIf="showRecordedVideo"
          [src]="recordedVideoUrl"
          controls
          autoplay
          style="width: 100%; height: 100%; object-fit: contain;"
        ></video>

        <!-- Menú de herramientas (Radio Buttons) -->
        <div class="radio-input open" (change)="onRadioChange($event)">
          <!-- Play -->
          <label class="label label-play" [class.selected]="selectedTool === 'play'">
            <input type="radio" id="play" name="value-radio" value="play" />
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
              <path d="M96 52v408l320-204-320-204z" />
            </svg>
          </label>

          <!-- Play2 + Stop anidado -->
          <label class="label label-play2">
            <input type="radio" id="play2" name="value-radio" value="play2" />
            <img class="icon-play2" src="assets/play-bucle.svg" alt="Play2" />
            <label class="label-stop">
              <input type="radio" id="stop" name="value-radio" value="stop" />
              <svg class="icon-stop" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path d="M64 64h384v384H64z" />
              </svg>
            </label>
          </label>

          <!-- Webcam -->
          <label class="label label-webcam">
            <input type="radio" id="webcam" name="value-radio" value="webcam" />
            <img class="icon-webcam" src="assets/webcam.svg" alt="Webcam" />
          </label>

          <!-- Velocidad (Speed) -->
          <label class="label">
            <input type="radio" id="veloc" name="value-radio" value="veloc" />
            <span class="text">Veloc</span>
          </label>
        </div>

        <!-- Parte superior-derecha: palabra y botón Grabar -->
        <div class="top-right-container" *ngIf="showWebcam">
          <div class="current-word" (click)="handleWordClick()">
            <p>{{ currentWord }}</p>
          </div>
          <button 
            *ngIf="!isRecording"
            (click)="startRecording()"
            class="record-btn"
          >
            Empezar a grabar
          </button>
          <button 
            *ngIf="isRecording"
            (click)="terminarGrabacion()"
            class="stop-recording-btn"
          >
            Terminar de grabar
          </button>
        </div>
      </div><!-- Fin image-container -->

      <!-- Contenedor derecho con la cámara activa -->
      <div class="camera-container" *ngIf="showWebcam">
        <video #videoElement class="mirror-video" autoplay></video>
      </div>

      <div class="right-panel" *ngIf="!showWebcam">
        <div class="icon-menu-fixed">
          <a (click)="volverAModos()" title="Modos">
            <i class="fa-solid fa-home"></i>
          </a>
        </div>
      
        <!-- Envolvemos el resto en .versus-wrapper -->
        <div class="versus-wrapper">
          <h2 class="exam-title">¡Adivina la palabra!</h2>
          <p class="enunciado-general">
            ¿Qué palabra ha signado <strong>{{ currentTurnName }}</strong>?
          </p>
      
          <div *ngIf="cargandoPregunta">Cargando pregunta...</div>
      
          <div class="word-list" *ngIf="opciones && !cargandoPregunta">
            <div
              class="word-item"
              *ngFor="let opcion of opciones"
              (click)="seleccionarOpcion(opcion._id)"
              [ngClass]="{
                'correct-answer': optionStatus[opcion._id] === 'correct',
                'wrong-answer': optionStatus[opcion._id] === 'incorrect'
              }"
            >
              {{ opcion.palabra }}
            </div>
          </div>

          <!-- NUEVO: Scoreboard + botón siguiente turno -->
          <div class="scoreboard">
            <div class="player-score">
              <span class="player-name">{{ player1Name }}</span>
              <!-- Tres circulitos -->
              <span 
                class="circle"
                *ngFor="let slot of player1Score"
                [ngClass]="{
                  'hit': slot === 'hit',
                  'miss': slot === 'miss',
                  'empty': slot === 'empty'
                }"
              ></span>
            </div>

            <div class="player-score">
              <span class="player-name">{{ player2Name }}</span>
              <span 
                class="circle"
                *ngFor="let slot of player2Score"
                [ngClass]="{
                  'hit': slot === 'hit',
                  'miss': slot === 'miss',
                  'empty': slot === 'empty'
                }"
              ></span>
            </div>
          </div>

          <!-- Botón para cambiar el turno -->
          <!-- Botón de "Siguiente Turno" con mismo estilo que "Nueva Pregunta" -->
          <div style="margin-top: 2rem; display: flex; justify-content: center;">
            <button class="next-turn-btn" (click)="nextTurn()">
              Siguiente Turno
            </button>
          </div>

          <!-- Feedback -->
          <div 
            *ngIf="resultado"
            class="resultado"
            [ngClass]="{
              'resultado-correcto': resultado==='¡Respuesta correcta!',
              'resultado-incorrecto': resultado==='Respuesta incorrecta'
            }"
            >
            <p>
              <i *ngIf="resultado==='¡Respuesta correcta!'" class="fa-solid fa-circle-check icon-correct"></i>
              <i *ngIf="resultado==='Respuesta incorrecta'" class="fa-solid fa-circle-xmark icon-incorrect"></i>
              {{ resultado }}
            </p>
          </div>
          

        </div> <!-- Fin .versus-wrapper -->
      
      </div> <!-- Fin .right-panel -->      

    </div><!-- Fin layout -->
  </div><!-- Fin PANTALLA 3: playing -->
  <!-- Overlay para anunciar al ganador -->
  <div *ngIf="uiState === 'finPartida'" class="winner-overlay">
    <div class="winner-message">
      <h1>¡Felicidades {{ ganador }} has ganado!</h1>
      <p>La partida ha terminado.</p>
      <button (click)="volverAModos()">Volver a Modos</button>
    </div>
  </div>

</div><!-- Fin container -->
