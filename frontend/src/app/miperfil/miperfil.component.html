<app-header></app-header>

<div class="icon-menu-fixed">
  <a (click)="volverAModos()" title="Modos">
    <i id="icon-perfil" class="fa-solid fa-home"></i>
  </a>
  <a (click)="navigateTo('perfil')" title="Mi Perfil">
    <i class="fa-solid fa-user"></i>
  </a>
  <a (click)="logout()" title="Cerrar Sesión" class="logout-icon">
    <i class="fa-solid fa-right-from-bracket"></i>
  </a>
</div>

<!-- Contenedor principal con estructura grid para 6 tarjetas -->
<div class="dashboard-container">
  <!-- Columna izquierda: Tarjeta de perfil -->
  <div class="profile-column">
    <div class="card">
      <div class="card__img">
        <svg width="100%" xmlns="http://www.w3.org/2000/svg">
          <!-- SVG code sin cambios -->
          <rect height="450" width="540" fill="#ffffff"></rect>
          <defs>
            <linearGradient
              gradientTransform="rotate(222,648,379)"
              y2="100%"
              y1="0"
              x2="0"
              x1="0"
              gradientUnits="userSpaceOnUse"
              id="a"
            >
              <stop stop-color="#f2c464" offset="0"></stop>
              <stop stop-color="#d8a33f" offset="1"></stop>
            </linearGradient>
            <pattern
              viewBox="0 0 1080 900"
              y="0"
              x="0"
              height="250"
              width="300"
              id="b"
              patternUnits="userSpaceOnUse"
            >
              <g fill-opacity="0.5">
                <polygon points="90 150 0 300 180 300" fill="#f2c464"></polygon>
                <polygon points="90 150 180 0 0 0" fill="#d8a33f"></polygon>
                <polygon points="270 150 360 0 180 0" fill="#f4b35c"></polygon>
                <polygon
                  points="450 150 360 300 540 300"
                  fill="#f2c464"
                ></polygon>
                <polygon points="450 150 540 0 360 0" fill="#f4b35c"></polygon>
                <polygon
                  points="630 150 540 300 720 300"
                  fill="#f2c464"
                ></polygon>
                <polygon points="630 150 720 0 540 0" fill="#f4b35c"></polygon>
                <polygon
                  points="810 150 720 300 900 300"
                  fill="#f4b35c"
                ></polygon>
                <polygon points="810 150 900 0 720 0" fill="#d8a33f"></polygon>
                <polygon
                  points="990 150 900 300 1080 300"
                  fill="#f2c464"
                ></polygon>
                <polygon points="990 150 1080 0 900 0" fill="#f4b35c"></polygon>
                <polygon points="90 450 0 600 180 600" fill="#f4b35c"></polygon>
                <polygon points="90 450 180 300 0 300" fill="#f2c464"></polygon>
                <polygon
                  points="270 450 180 600 360 600"
                  fill="#f4b35c"
                ></polygon>
                <polygon
                  points="270 450 360 300 180 300"
                  fill="#d8a33f"
                ></polygon>
                <polygon
                  points="450 450 360 600 540 600"
                  fill="#f2c464"
                ></polygon>
                <polygon
                  points="450 450 540 300 360 300"
                  fill="#f4b35c"
                ></polygon>
                <polygon
                  points="630 450 540 600 720 600"
                  fill="#d8a33f"
                ></polygon>
                <polygon
                  points="630 450 720 300 540 300"
                  fill="#f4b35c"
                ></polygon>
                <polygon
                  points="810 450 720 600 900 600"
                  fill="#f2c464"
                ></polygon>
                <polygon
                  points="810 450 900 300 720 300"
                  fill="#d8a33f"
                ></polygon>
                <polygon
                  points="990 450 900 600 1080 600"
                  fill="#f4b35c"
                ></polygon>
                <polygon points="180 0 90 150 270 150" fill="#f4b35c"></polygon>
                <polygon
                  points="360 0 270 150 450 150"
                  fill="#d8a33f"
                ></polygon>
                <polygon
                  points="540 0 450 150 630 150"
                  fill="#f2c464"
                ></polygon>
                <polygon
                  points="900 0 810 150 990 150"
                  fill="#f4b35c"
                ></polygon>
                <polygon points="0 300 -90 450 90 450" fill="#f4b35c"></polygon>
                <polygon points="0 300 90 150 -90 150" fill="#f2c464"></polygon>
                <polygon
                  points="180 300 90 450 270 450"
                  fill="#f2c464"
                ></polygon>
                <polygon
                  points="180 300 270 150 90 150"
                  fill="#f4b35c"
                ></polygon>
                <polygon
                  points="360 300 270 450 450 450"
                  fill="#f4b35c"
                ></polygon>
                <polygon
                  points="360 300 450 150 270 150"
                  fill="#f2c464"
                ></polygon>
                <polygon
                  points="540 300 450 450 630 450"
                  fill="#f2c464"
                ></polygon>
                <polygon
                  points="540 300 630 150 450 150"
                  fill="#f4b35c"
                ></polygon>
                <polygon
                  points="720 300 630 450 810 450"
                  fill="#f4b35c"
                ></polygon>
                <polygon
                  points="720 300 810 150 630 150"
                  fill="#f2c464"
                ></polygon>
                <polygon
                  points="900 300 810 450 990 450"
                  fill="#f2c464"
                ></polygon>
                <polygon
                  points="900 300 990 150 810 150"
                  fill="#f4b35c"
                ></polygon>
                <polygon points="0 600 -90 750 90 750" fill="#f4b35c"></polygon>
                <polygon points="0 600 90 450 -90 450" fill="#f4b35c"></polygon>
                <polygon
                  points="180 600 90 750 270 750"
                  fill="#f2c464"
                ></polygon>
                <polygon
                  points="180 600 270 450 90 450"
                  fill="#d8a33f"
                ></polygon>
                <polygon
                  points="360 600 270 750 450 750"
                  fill="#f4b35c"
                ></polygon>
                <polygon
                  points="360 600 450 450 270 450"
                  fill="#f2c464"
                ></polygon>
                <polygon
                  points="540 600 630 450 450 450"
                  fill="#f4b35c"
                ></polygon>
                <polygon
                  points="720 600 630 750 810 750"
                  fill="#f4b35c"
                ></polygon>
                <polygon
                  points="900 600 810 750 990 750"
                  fill="#f2c464"
                ></polygon>
                <polygon
                  points="900 600 990 450 810 450"
                  fill="#f2c464"
                ></polygon>
                <polygon points="0 900 90 750 -90 750" fill="#f2c464"></polygon>
                <polygon
                  points="180 900 270 750 90 750"
                  fill="#f4b35c"
                ></polygon>
                <polygon
                  points="360 900 450 750 270 750"
                  fill="#f2c464"
                ></polygon>
                <polygon
                  points="540 900 630 750 450 750"
                  fill="#f2c464"
                ></polygon>
                <polygon
                  points="720 900 810 750 630 750"
                  fill="#f4b35c"
                ></polygon>
                <polygon
                  points="900 900 990 750 810 750"
                  fill="#d8a33f"
                ></polygon>
              </g>
            </pattern>
          </defs>
          <rect height="100%" width="100%" fill="url(#a)" y="0" x="0"></rect>
          <rect height="100%" width="100%" fill="url(#b)" y="0" x="0"></rect>
        </svg>
      </div>

      <div class="card__avatar">
        <img
          src="assets/perfil3.jpg"
          alt="Avatar"
          style="
            border-radius: 50%;
            width: 128px;
            height: 128px;
            object-fit: cover;
          "
        />
      </div>

      <div class="card__title">{{ emailUsuario }}</div>
      <div class="card__wrapper">
        <button class="card__btn card__btn-solid" (click)="openModal()">
          <i class="fas fa-edit"></i>Editar Correo
        </button>
        <button class="card__btn card__btn-solid" (click)="openPasswordModal()">
          <i class="fas fa-edit"></i>Editar Contraseña
        </button>
      </div>
    </div>
  </div>

  <!-- Columna derecha: Estadísticas -->
  <div class="stats-column">
    <!-- Primera fila: 2 gráficos -->
    <div class="stats-row two-cols">
      <!-- 1) Exámenes -->
      <div class="stats-card">
        <h3><i class="fa-solid fa-chart-pie"></i>Mi Rendimiento en Exámenes</h3>
        <ngx-charts-pie-chart
          [results]="examStats"
          [view]="[400, 300]"
          [legend]="false"
          [labels]="true"
          [scheme]="colorScheme"
          [animations]="true"
          [doughnut]="false"
        >
        </ngx-charts-pie-chart>
      </div>

      <!-- 2) Login stats -->
      <div class="stats-card">
        <h3><i class="fa-solid fa-calendar-check"></i>Mi actividad</h3>
        <p><strong>Días con login:</strong> {{ loginStats.totalDays }}</p>
        <p class="small">
          <span>● Racha actual: {{ loginStats.currentStreak }} día(s)</span>
          &nbsp;|&nbsp;
          <span>● Racha máxima: {{ loginStats.maxStreak }} día(s)</span>
        </p>
      </div>
    </div>

    <!-- Segunda fila: 3 gráficos -->
    <div class="stats-row three-cols">
      <!-- 3) Top palabras aprendidas -->
      <div class="stats-card">
        <h3><i class="fa-solid fa-book"></i>Mis Palabras Más Aprendidas</h3>
        <ngx-charts-bar-vertical
          [view]="[280, 240]"
          [results]="barChartData"
          [scheme]="colorScheme"
          [gradient]="false"
          [xAxis]="true"
          [yAxis]="true"
          xAxisLabel="Palabra"
          yAxisLabel="Clicks"
          [roundEdges]="true"
        >
        </ngx-charts-bar-vertical>
      </div>

      <!-- 4) Top versus -->
      <div class="stats-card">
        <h3><i class="fa-solid fa-trophy"></i>Top 3 Ganadores Versus</h3>
        <ngx-charts-bar-vertical
          [view]="[320, 190]"
          [results]="topVersus"
          [scheme]="colorScheme"
          [gradient]="false"
          [xAxis]="true"
          [yAxis]="true"
          xAxisLabel="Jugador"
          yAxisLabel="Victorias"
          [roundEdges]="true"
        >
        </ngx-charts-bar-vertical>
      </div>

      <!-- 5) Niveles completados -->
      <div class="stats-card">
        <h3><i class="fa-solid fa-puzzle-piece"></i>Niveles Completados</h3>
        <ng-container *ngIf="completedLevels > 0; else noLevels">
          <ngx-charts-pie-chart
            [results]="levelsPieData"
            [view]="[250, 190]"
            [legend]="false"
            [labels]="true"
            [scheme]="colorScheme"
          >
          </ngx-charts-pie-chart>
        </ng-container>
        <ng-template #noLevels>
          <p class="text-center">No hay niveles completados aún.</p>
        </ng-template>
      </div>
    </div>
  </div>
</div>
<!-- Div de dashboard container -->

<!-- Modal Email (sin cambios) -->
<div id="emailModal" class="modal" *ngIf="isModalOpen">
  <div class="modal-content">
    <h3 style="font-weight: bold; text-transform: uppercase">
      <i class="fa-solid fa-envelope"></i> Actualiza tu correo
    </h3>
    <p
      *ngIf="!emailSuccessMessageVisible"
      style="font-size: 0.9em; margin-bottom: 15px"
    >
      Introduce tu email actual y el nuevo email al que quieres cambiar tu
      cuenta
    </p>

    <!-- Formulario de edición -->
    <form *ngIf="!emailSuccessMessageVisible" (ngSubmit)="updateEmail()">
      <!-- Input para email actual -->
      <div
        class="form-group"
        [ngClass]="{ 'show-error': emailErrorField === 'currentEmail' }"
      >
        <input
          type="email"
          id="currentEmail"
          [(ngModel)]="currentEmail"
          name="currentEmail"
          required
          placeholder="Email actual"
        />
        <p
          class="error-message"
          [class.visible]="emailErrorField === 'currentEmail'"
        >
          <i class="fa-solid fa-triangle-exclamation"></i>
          El email actual no es correcto
        </p>
      </div>

      <!-- Input para nuevo email -->
      <div
        class="form-group"
        [ngClass]="{ 'show-error': emailErrorField === 'newEmail' }"
      >
        <input
          type="email"
          id="newEmail"
          [(ngModel)]="newEmail"
          name="newEmail"
          required
          placeholder="Nuevo email"
        />
        <p
          class="error-message"
          [class.visible]="emailErrorField === 'currentEmail'"
        >
          <i class="fa-solid fa-triangle-exclamation"></i>
          El nuevo email no es válido
        </p>
      </div>

      <div style="display: flex; justify-content: center; gap: 10px">
        <button
          type="button"
          class="start-button cancel-button"
          (click)="closeModal()"
        >
          Cancelar
        </button>
        <button type="submit" class="start-button">Actualizar</button>
      </div>
    </form>
    <div *ngIf="emailSuccessMessageVisible">
      <p style="font-size: 1.1em; margin-top: 20px">
        <i class="fa-solid fa-circle-check" style="color: green"></i>
        Email actualizado correctamente
      </p>
      <button
        type="button"
        class="start-button"
        style="margin-top: 15px"
        (click)="confirmEmailUpdateSuccess()"
      >
        Aceptar
      </button>
    </div>
  </div>
</div>

<!-- Modal Contraseña (sin cambios) -->
<div id="passwordModal" class="modal" *ngIf="isPasswordModalOpen">
  <div class="modal-content">
    <h3 style="font-weight: bold; text-transform: uppercase">
      <i class="fa-solid fa-lock"></i> Cambia tu contraseña
    </h3>
    <p
      *ngIf="!passwordSuccessMessageVisible"
      style="font-size: 0.9em; margin-bottom: 15px"
    >
      Introduce tu contraseña actual y la nueva contraseña que deseas usar
    </p>

    <form *ngIf="!passwordSuccessMessageVisible" (ngSubmit)="updatePassword()">
      <!-- Formulario de edición de contraseña -->
      <form (ngSubmit)="updatePassword()">
        <!-- Input para contraseña actual -->
        <div
          class="form-group"
          [ngClass]="{ 'show-error': passwordErrorField === 'currentPassword' }"
        >
          <div class="password-wrapper">
            <input
              [type]="currentPasswordInputType"
              id="currentPassword"
              [(ngModel)]="currentPassword"
              name="currentPassword"
              required
              placeholder="Contraseña actual"
            />
            <button
              type="button"
              class="toggle-password-btn"
              (click)="toggleCurrentPasswordVisibility()"
            >
              <i
                [ngClass]="
                  showCurrentPassword ? 'fa fa-eye-slash' : 'fa fa-eye'
                "
              ></i>
            </button>
          </div>
          <p
            class="error-message"
            [class.visible]="passwordErrorField === 'currentPassword'"
          >
            <i class="fa-solid fa-triangle-exclamation"></i> La contraseña
            actual no es correcta
          </p>
        </div>

        <!-- Input para nueva contraseña -->
        <div
          class="form-group"
          [ngClass]="{ 'show-error': passwordErrorField === 'newPassword' }"
        >
          <div class="password-wrapper">
            <input
              [type]="currentPasswordInputType"
              id="newPassword"
              [(ngModel)]="newPassword"
              name="newPassword"
              required
              placeholder="Nueva contraseña"
            />
            <button
              type="button"
              class="toggle-password-btn"
              (click)="toggleCurrentPasswordVisibility()"
            >
              <i
                [ngClass]="
                  showCurrentPassword ? 'fa fa-eye-slash' : 'fa fa-eye'
                "
              ></i>
            </button>
          </div>
          <p
            class="error-message"
            [class.visible]="passwordErrorField === 'newPassword'"
          >
            <i class="fa-solid fa-triangle-exclamation"></i> La nueva contraseña
            no es válida
          </p>
        </div>

        <!-- Input para repetir nueva contraseña -->
        <div
          class="form-group"
          [ngClass]="{ 'show-error': passwordErrorField === 'confirmPassword' }"
        >
          <div class="password-wrapper">
            <input
              [type]="currentPasswordInputType"
              id="confirmPassword"
              [(ngModel)]="confirmPassword"
              name="confirmPassword"
              required
              placeholder="Repetir nueva contraseña"
            />
            <button
              type="button"
              class="toggle-password-btn"
              (click)="toggleCurrentPasswordVisibility()"
            >
              <i
                [ngClass]="
                  showCurrentPassword ? 'fa fa-eye-slash' : 'fa fa-eye'
                "
              ></i>
            </button>
          </div>
          <p
            class="error-message"
            [class.visible]="passwordErrorField === 'confirmPassword'"
          >
            <i class="fa-solid fa-triangle-exclamation"></i> Las contraseñas no
            coinciden
          </p>
        </div>

        <!-- Botones -->
        <div style="display: flex; justify-content: center; gap: 10px">
          <button
            type="button"
            class="start-button cancel-button"
            (click)="closePasswordModal()"
          >
            Cancelar
          </button>
          <button type="submit" class="start-button">Actualizar</button>
        </div>
      </form>
    </form>
    <div *ngIf="passwordSuccessMessageVisible">
      <p style="font-size: 1.1em; margin-top: 20px">
        <i class="fa-solid fa-circle-check" style="color: green"></i>
        Contraseña actualizada correctamente
      </p>
      <button
        type="button"
        class="start-button"
        style="margin-top: 15px"
        (click)="confirmPasswordUpdateSuccess()"
      >
        Aceptar
      </button>
    </div>
  </div>
</div>
